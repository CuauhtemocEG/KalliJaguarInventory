<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Compatibilidad - Navegadores Chrome/Android/Windows</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { 
            background: #f0f0f0; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🔍 Test de Compatibilidad para Login</h1>
    <p><strong>Propósito:</strong> Diagnosticar problemas específicos en Chrome, Android y Windows</p>
    
    <div class="test-section">
        <h2>📱 Información del Navegador</h2>
        <div id="browser-info"></div>
    </div>

    <div class="test-section">
        <h2>🍪 Test de Cookies</h2>
        <div id="cookie-test"></div>
    </div>

    <div class="test-section">
        <h2>🔄 Test de Fetch API</h2>
        <div id="fetch-test"></div>
        <button onclick="testFetch()">Probar Fetch</button>
    </div>

    <div class="test-section">
        <h2>📡 Test de Sesión</h2>
        <div id="session-test"></div>
        <button onclick="testSession()">Probar Sesión</button>
    </div>

    <div class="test-section">
        <h2>🔐 Test de Login</h2>
        <form id="testLoginForm">
            <input type="text" placeholder="Usuario" id="testUser" value="test">
            <input type="password" placeholder="Contraseña" id="testPass" value="test">
            <button type="submit">Probar Login</button>
        </form>
        <div id="login-test"></div>
    </div>

    <script>
        // Detección de navegador y plataforma
        const userAgent = navigator.userAgent;
        const isAndroid = /Android/i.test(userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isWindows = /Windows/i.test(userAgent);
        const isMac = /Mac/i.test(userAgent);
        const isChrome = /Chrome/i.test(userAgent);
        const isEdge = /Edge|Edg/i.test(userAgent);
        const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
        const isFirefox = /Firefox/i.test(userAgent);

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : 
                             type === 'error' ? 'error' : 
                             type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        // Test 1: Información del navegador
        function testBrowser() {
            const info = document.getElementById('browser-info');
            info.innerHTML = `
                <pre>
User Agent: ${userAgent}

Detección de Plataforma:
- Android: ${isAndroid}
- iOS: ${isIOS} 
- Windows: ${isWindows}
- Mac: ${isMac}

Detección de Navegador:
- Chrome: ${isChrome}
- Edge: ${isEdge}
- Safari: ${isSafari}
- Firefox: ${isFirefox}

Capacidades:
- Cookies habilitadas: ${navigator.cookieEnabled}
- Local Storage: ${typeof(Storage) !== "undefined"}
- Fetch API: ${typeof fetch !== 'undefined'}
- Promesas: ${typeof Promise !== 'undefined'}

Pantalla:
- Resolución: ${screen.width}x${screen.height}
- Viewport: ${window.innerWidth}x${window.innerHeight}
- Device Pixel Ratio: ${window.devicePixelRatio}

Conexión:
- Online: ${navigator.onLine}
- Connection: ${navigator.connection ? navigator.connection.effectiveType : 'No disponible'}
                </pre>
            `;
        }

        // Test 2: Cookies
        function testCookies() {
            log('cookie-test', 'Iniciando test de cookies...');
            
            if (!navigator.cookieEnabled) {
                log('cookie-test', 'ERROR: Cookies deshabilitadas en el navegador', 'error');
                return false;
            }
            
            // Test básico
            document.cookie = "test_basic=1; path=/";
            if (document.cookie.indexOf("test_basic=1") !== -1) {
                log('cookie-test', 'SUCCESS: Cookie básica funciona', 'success');
                document.cookie = "test_basic=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            } else {
                log('cookie-test', 'ERROR: Falla cookie básica', 'error');
            }
            
            // Test con SameSite
            document.cookie = "test_samesite=1; path=/; SameSite=Lax";
            if (document.cookie.indexOf("test_samesite=1") !== -1) {
                log('cookie-test', 'SUCCESS: Cookie con SameSite=Lax funciona', 'success');
                document.cookie = "test_samesite=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            } else {
                log('cookie-test', 'WARNING: Falla cookie con SameSite', 'warning');
            }

            log('cookie-test', `Cookies actuales: ${document.cookie}`);
        }

        // Test 3: Fetch API
        async function testFetch() {
            log('fetch-test', 'Probando Fetch API...');
            
            try {
                const response = await fetch('./debug_session.php', {
                    method: 'GET',
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });
                
                log('fetch-test', `Response status: ${response.status}`, 'info');
                log('fetch-test', `Response ok: ${response.ok}`, 'info');
                
                const text = await response.text();
                log('fetch-test', `Response length: ${text.length} chars`, 'info');
                
                if (response.ok) {
                    log('fetch-test', 'SUCCESS: Fetch funcionando correctamente', 'success');
                    try {
                        const data = JSON.parse(text);
                        log('fetch-test', `Datos JSON recibidos: ${JSON.stringify(data, null, 2)}`, 'success');
                    } catch (e) {
                        log('fetch-test', `Respuesta no es JSON válido: ${text.substring(0, 200)}...`, 'warning');
                    }
                } else {
                    log('fetch-test', 'ERROR: Response no ok', 'error');
                }
                
            } catch (error) {
                log('fetch-test', `ERROR: ${error.message}`, 'error');
                log('fetch-test', `Error name: ${error.name}`, 'error');
            }
        }

        // Test 4: Sesión
        async function testSession() {
            log('session-test', 'Probando endpoint de sesión...');
            
            try {
                const response = await fetch('./debug_session.php');
                const data = await response.json();
                
                log('session-test', `Session ID: ${data.session_info.session_id}`, 'info');
                log('session-test', `Session Status: ${data.session_info.session_status}`, 'info');
                log('session-test', `Datos completos:`, 'info');
                
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                document.getElementById('session-test').appendChild(pre);
                
            } catch (error) {
                log('session-test', `ERROR: ${error.message}`, 'error');
            }
        }

        // Test 5: Login
        document.getElementById('testLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            log('login-test', 'Probando proceso de login...');
            
            const formData = new FormData();
            formData.append('login_usuario', document.getElementById('testUser').value);
            formData.append('login_clave', document.getElementById('testPass').value);
            
            try {
                const response = await fetch('./api/loginHandler.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });
                
                log('login-test', `Response status: ${response.status}`, 'info');
                
                const text = await response.text();
                log('login-test', `Response text: ${text}`, 'info');
                
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        log('login-test', 'SUCCESS: Login simulado exitoso', 'success');
                    } else {
                        log('login-test', `Login falló: ${data.message}`, 'warning');
                    }
                } catch (e) {
                    log('login-test', 'ERROR: Respuesta no es JSON válido', 'error');
                }
                
            } catch (error) {
                log('login-test', `ERROR: ${error.message}`, 'error');
            }
        });

        // Ejecutar tests automáticos
        document.addEventListener('DOMContentLoaded', function() {
            testBrowser();
            testCookies();
        });
    </script>
</body>
</html>
